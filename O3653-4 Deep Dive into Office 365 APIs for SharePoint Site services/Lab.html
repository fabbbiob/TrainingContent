<!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAYcAA0AAAAACjQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABMAAAABwAAAAca8vGTk9TLzIAAAFMAAAARAAAAFZG1VHVY21hcAAAAZAAAAA+AAABQgAP9AdjdnQgAAAB0AAAAAQAAAAEACICiGdhc3AAAAHUAAAACAAAAAj//wADZ2x5ZgAAAdwAAADRAAABEKyikaNoZWFkAAACsAAAAC0AAAA2AtXoA2hoZWEAAALgAAAAHAAAACQHngNFaG10eAAAAvwAAAAQAAAAEAwAACJsb2NhAAADDAAAAAoAAAAKALIAVG1heHAAAAMYAAAAHwAAACABEAB2bmFtZQAAAzgAAALBAAAFu3I9x/Nwb3N0AAAF/AAAAB0AAAAvaoFvbwAAAAEAAAAAzBdyYwAAAADP2IQvAAAAAM/bz7t4nGNgZGFgnMDAysDB1Ml0hoGBoR9CM75mMGLkYGBgYmBlZsAKAtJcUxgcPsR8iGF2+O/AEMPsznAYKMwIkgMA5REMOXicY2BgYGaAYBkGRgYQsAHyGMF8FgYFIM0ChED+h5j//yEk/3KoSgZGNgYYk4GRCUgwMaACRoZhDwCs7QgGAAAAIgKIAAAAAf//AAJ4nHWMMQrCQBBF/0zWrCCIKUQsTDCL2EXMohYGSSmorScInsRGL2DOYJe0Ntp7BK+gJ1BxF1stZvjz/v8DRghQzEc4kIgKwiAppcA9LtzKLSkdNhKFY3HF4lK69ExKslx7Xa+vPRVS43G98vG1DnkDMIBUgFN0MDXflU8tbaZOUkXUH0+U27RoRpOIyCKjbMCVejwypzJJG4jIwb43rfl6wbwanocrJm9XFYfskuVC5K/TPyczNU7b84CXcbxks1Un6H6tLH9vf2LRnn8Ax7A5WQAAAHicY2BkYGAA4teL1+yI57f5ysDNwgAC529f0kOmWRiYVgEpDgYmEA8AUzEKsQAAAHicY2BkYGB2+O/AEMPCAAJAkpEBFbAAADgKAe0EAAAiAAAAAAQAAAAEAAAAAAAAKgAqACoAiAAAeJxjYGRgYGBhsGFgYgABEMkFhAwM/xn0QAIAD6YBhwB4nI1Ty07cMBS9QwKlQapQW3VXySvEqDCZGbGaHULiIQ1FKgjWMxknMfLEke2A+IJu+wntrt/QbVf9gG75jK577Lg8K1qQPCfnnnt8fX1NRC/pmjrk/zprC+8D7tBy9DHgBXoWfQ44Av8t4Bj4Z8CLtBL9CniJluPXASf0Lm4CXqFX8Q84dOLnMB17N4c7tBo1AS/Qi+hTwBH4rwHHwN8DXqQ30XXAS7QaLwSc0Gn8NuAVWou/gFmnjLrEaEh9GmDdDGgL3B4JsrRPDU2hTOiMSuJUIdKQQayiAth69r6akSSFqIJuA19TrzCIaY8sIoxyrNIrL//pw7A2iMygkX5vDj+G+kuoLdX4GlGK/8Lnlz6/h9MpmoO9rafrz7ILXEHHaAx95s9lsI7AHNMBWEZHULnfAXwG9/ZqdzLI08iuwRloXE8kfhXYAvE23+23DU3t626rbs8/8adv+9DWknsHp3E17oCf+Z48rvEQNZ78paYM38qfk3v/u3l3u3GXN2Dmvmvpf1Srwk3pB/VSsp512bA/GG5i2WJ7wu430yQ5K3nFGiOqgtmSB5pJVSizwaacmUZzZhXLlZTq8qGGFY2YcSkqbth6aW1tRmlaCFs2016m5qn36SbJrqosG4uMV4aP2PHBmB3tjtmgN2izkGQyLWprekbIntJFing32a5rKWCN/SdSoga45EJykyQ7asZvHQ8PTm6cslIpwyeyjbVltNikc2HTR7YKh9LBl9DADC0U/jLcBZDKrMhUBfQBvXRzLtFtjU9eNHKin0x5InTqb8lNpfKv1s1xHzTXRqgKzek/mb7nB8RZTCDhGEX3kK/8Q75AmUM/eLkfA+0Hi908Kx4eNsMgudg5GLdRD7a84npi+YxNr5i5KIbW5izXas7cHXIMAau1OueZhfj+cOcP3P8MNIWLyYOBuxL6DRylJ4cAAAB4nGNgYoAALjDJyIAOWMCiTIxMLDmZedkABtIBygAAAA==) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .h {
  color: #333;
  font-style: normal;
  font-weight: normal;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs,
.markdown-body .highlight .cp .h {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #000;
  border: 1px solid #cfcfcf;
  border-radius: 2px;
}

.markdown-body .highlight .pl-coc,
.markdown-body .highlight .pl-entm,
.markdown-body .highlight .pl-eoa,
.markdown-body .highlight .pl-mai .pl-sf,
.markdown-body .highlight .pl-pdv,
.markdown-body .highlight .pl-sc,
.markdown-body .highlight .pl-sr,
.markdown-body .highlight .pl-v,
.markdown-body .highlight .pl-vpf {
  color: #0086b3;
}

.markdown-body .highlight .pl-eoac,
.markdown-body .highlight .pl-mdht,
.markdown-body .highlight .pl-mi1,
.markdown-body .highlight .pl-mri,
.markdown-body .highlight .pl-va,
.markdown-body .highlight .pl-vpu {
  color: #008080;
}

.markdown-body .highlight .pl-c,
.markdown-body .highlight .pl-pdc {
  color: #b4b7b4;
  font-style: italic;
}

.markdown-body .highlight .pl-k,
.markdown-body .highlight .pl-ko,
.markdown-body .highlight .pl-kolp,
.markdown-body .highlight .pl-mc,
.markdown-body .highlight .pl-mr,
.markdown-body .highlight .pl-ms,
.markdown-body .highlight .pl-s,
.markdown-body .highlight .pl-sok,
.markdown-body .highlight .pl-st {
  color: #6e5494;
}

.markdown-body .highlight .pl-ef,
.markdown-body .highlight .pl-enf,
.markdown-body .highlight .pl-enm,
.markdown-body .highlight .pl-entc,
.markdown-body .highlight .pl-eoi,
.markdown-body .highlight .pl-sf,
.markdown-body .highlight .pl-smc {
  color: #d12089;
}

.markdown-body .highlight .pl-ens,
.markdown-body .highlight .pl-eoai,
.markdown-body .highlight .pl-kos,
.markdown-body .highlight .pl-mh .pl-pdh,
.markdown-body .highlight .pl-mp,
.markdown-body .highlight .pl-pde,
.markdown-body .highlight .pl-stp {
  color: #458;
}

.markdown-body .highlight .pl-enti {
  color: #d12089;
  font-weight: bold;
}

.markdown-body .highlight .pl-cce,
.markdown-body .highlight .pl-enc,
.markdown-body .highlight .pl-kou,
.markdown-body .highlight .pl-mq {
  color: #f93;
}

.markdown-body .highlight .pl-mp1 .pl-sf {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .pl-cos,
.markdown-body .highlight .pl-ent,
.markdown-body .highlight .pl-md,
.markdown-body .highlight .pl-mdhf,
.markdown-body .highlight .pl-ml,
.markdown-body .highlight .pl-pdc1,
.markdown-body .highlight .pl-pds,
.markdown-body .highlight .pl-s1,
.markdown-body .highlight .pl-scp,
.markdown-body .highlight .pl-sol {
  color: #df5000;
}

.markdown-body .highlight .pl-c1,
.markdown-body .highlight .pl-cn,
.markdown-body .highlight .pl-pse,
.markdown-body .highlight .pl-pse .pl-s2,
.markdown-body .highlight .pl-vi {
  color: #a31515;
}

.markdown-body .highlight .pl-mb,
.markdown-body .highlight .pl-pdb {
  color: #df5000;
  font-weight: bold;
}

.markdown-body .highlight .pl-mi,
.markdown-body .highlight .pl-pdi {
  color: #6e5494;
  font-style: italic;
}

.markdown-body .highlight .pl-ms1 {
  background-color: #f5f5f5;
}

.markdown-body .highlight .pl-mdh,
.markdown-body .highlight .pl-mdi {
  font-weight: bold;
}

.markdown-body .highlight .pl-mdr {
  color: #0086b3;
  font-weight: bold;
}

.markdown-body .highlight .pl-s2 {
  color: #333;
}

.markdown-body .highlight .pl-ii {
  background-color: #df5000;
  color: #fff;
}

.markdown-body .highlight .pl-ib {
  background-color: #f93;
}

.markdown-body .highlight .pl-id {
  background-color: #a31515;
  color: #fff;
}

.markdown-body .highlight .pl-iu {
  background-color: #b4b7b4;
}

.markdown-body .highlight .pl-mo {
  color: #969896;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}</style><title>Lab</title></head><body><article class="markdown-body"><h1 id="office-365-apis-for-sharepoint-sites">
<a id="user-content-office-365-apis-for-sharepoint-sites" class="anchor" href="#office-365-apis-for-sharepoint-sites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Office 365 APIs for SharePoint Sites</h1>

<p>In this lab, you will use the Office 365 APIs for SharePoint Sites as part of an ASP.NET MVC5 application to manage a Tasks list.</p>

<h2 id="prerequisites">
<a id="user-content-prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h2>

<ol>
<li>You must have an Office 365 tenant and Windows Azure subscription to complete this lab. If you do not have one, the lab for <strong>O3651-7 Setting up your Developer environment in Office 365</strong> shows you how to obtain a trial.</li>
<li>You must have the Office 365 API Tools version 1.2.41027.2 installed in Visual Studio 2013.</li>
<li>You must have a task list named "Tasks" in the root site of SharePoint Online.</li>
</ol>

<h2 id="exercise-1-create-an-aspnet-mvc5-application">
<a id="user-content-exercise-1-create-an-aspnet-mvc5-application" class="anchor" href="#exercise-1-create-an-aspnet-mvc5-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exercise 1: Create an ASP.NET MVC5 Application</h2>

<p>In this exercise, you will create the ASP.NET MVC5 application and register it with Azure active Directory.</p>

<ol>
<li>
<p>Create the new solution in Visual Studio 2013:</p>

<ol>
<li>Launch <strong>Visual Studio 2013</strong> as administrator. </li>
<li>In Visual Studio select <strong>File/New/Project</strong>.</li>
<li>
<p>In the <strong>New Project</strong> dialog:</p>

<ol>
<li>Select <strong>Templates/Visual C#/Web</strong>.</li>
<li>Click <strong>ASP.NET Web Application</strong>.</li>
<li>Name the new project <strong>TasksWeb</strong>.</li>
<li>
<p>Click <strong>OK</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/01.png?raw=true" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/01.png?raw=true" alt="" title="Figure 1" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
<li>
<p>In the <strong>New ASP.NET Project</strong> dialog:</p>

<ol>
<li>Click <strong>MVC</strong>.</li>
<li>Click <strong>Change Authentication</strong>.</li>
<li>Select <strong>No Authentication</strong>.</li>
<li>
<p>Click <strong>OK</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/02.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/02.png" alt="" style="max-width:100%;"></a></p>
</li>
<li>
<p>Click <strong>OK</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/03.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/03.png" alt="" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Update the web project to use SSL by default:</p>

<ol>
<li>In the <strong>Solution Explorer</strong> tool window, select the project and look at the <strong>Properties</strong> tool window. </li>
<li>Change the property <strong>SSL Enabled</strong> to <strong>TRUE</strong>.</li>
<li>Copy the <strong>SSL URL</strong> property to the clipboard for use in the next step.</li>
<li>
<p>Save your changes.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/SslEnabled.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/SslEnabled.png" alt="" style="max-width:100%;"></a></p>

<blockquote>
<p>It is important to do this now because in the next step when you create the application in Azure AD, you want the reply URL to use HTTPS. If you did not do this now, you would have to manually make the changes the Visual Studio wizard is going to do for you in creating the app.</p>
</blockquote>
</li>
</ol>
</li>
<li>
<p>Configure the project to always go to the homepage of the web application when debugging:</p>

<ol>
<li>In the <strong>Solution Explorer</strong> tool window &amp; select <strong>Properties</strong>.</li>
<li>Select the <strong>Web</strong> tab in the left margin.</li>
<li>Find the section <strong>Start Action</strong>.</li>
<li>Click the radio button <strong>Start URL</strong> and enter the SSL URL of the web project that you copied from the previous step.</li>
</ol>
</li>
<li>
<p>Connect the SharePoint Sites service:</p>

<ol>
<li>In the <strong>Solution Explorer</strong>, right click the <strong>TasksWeb</strong> project and select <strong>Add/Connected Service</strong>.</li>
<li>
<p>In the <strong>Services Manager</strong> dialog:</p>

<ol>
<li>Click <strong>Register Your App</strong>.</li>
<li>When prompted, login with your <strong>Organizational Account</strong>.</li>
<li>Click <strong>Users and Groups</strong>.

<ol>
<li>Click <strong>Permissions</strong>.<br>
</li>
<li>Check <strong>Enable sign-on and read users' profiles</strong>.</li>
<li>Click <strong>Apply</strong>.</li>
</ol>
</li>
<li>
<p>Click <strong>Sites</strong>.</p>

<ol>
<li>Click <strong>Permissions</strong>.</li>
<li>Check <strong>Create or Delete Items and Lists in All Site Collections</strong>.</li>
<li>Check <strong>Edit or Delete Items in All Site Collections</strong>.</li>
<li>Check <strong>Read Items in All Site Collections</strong>.</li>
<li>Click <strong>Apply</strong>.</li>
</ol>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/04.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/04.png" alt="" style="max-width:100%;"></a></p>
</li>
<li>
<p>Click <strong>OK</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/05.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/05.png" alt="" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>

<h2 id="exercise-2-configure-web-application-to-use-azure-ad-and-owin">
<a id="user-content-exercise-2-configure-web-application-to-use-azure-ad-and-owin" class="anchor" href="#exercise-2-configure-web-application-to-use-azure-ad-and-owin" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exercise 2: Configure Web Application to use Azure AD and OWIN</h2>

<p>In this exercise you will take the ASP.NET MVC web application you created in the previous exercise and configure it to use Azure AD &amp; OpenID Connect for user &amp; app authentication. You will do this by utilizing the OWIN framework. Once authenticated, you can use the access token returned by Azure AD to access the Office 365 APIs.</p>

<ol>
<li>
<p>Obtain and store the Azure AD tenant ID in the <code>web.config</code>.</p>

<ol>
<li>Browse to the <a href="https://manage.windowsazure.com">Azure Management Portal</a> and sign in with your <strong>Organizational Account</strong>.</li>
<li>In the left-hand navigation, click <strong>Active Directory</strong>.</li>
<li>Select the directory you share with your Office 365 subscription.</li>
<li>Select the application you created for this lab. This is the name of the application in the <strong>App Properties</strong> dialog when you were adding the <strong>Connected Service</strong> in the last exercise.</li>
<li>
<p>Select the <strong>Quick Start</strong> page for the in the top navigation... that's the left-most menu item that looks like a lightning bolt in a cloud:</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AppQuickStart.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AppQuickStart.png" alt="" style="max-width:100%;"></a></p>
</li>
<li>
<p>On the Quick Start page, expand the <strong>Get Started</strong> / <strong>Enable Users to Sign On</strong>. Locate the field <strong>Federation Metadata Document URL</strong>. Within that field value you will see a GUID immediately after the <code>login.windows.net</code> part of the URL. Copy just the GUID value to the clipboard.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/TenantId.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/TenantId.png" alt="" style="max-width:100%;"></a></p>
</li>
<li><p>Open the <code>web.config</code> file in the project.</p></li>
<li>
<p>Add the following node to the <code>&lt;appSettings&gt;</code> section, setting the value equal to the <strong>directory tenant ID</strong> you acquired in the previous step:</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">add</span> <span class="pl-e">key</span>=<span class="pl-s1"><span class="pl-pds">"</span>ida:AadTenantId<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s1"><span class="pl-pds">"</span>######-####-####-####-############<span class="pl-pds">"</span></span>/&gt;</pre></div>
</li>
</ol>
</li>
<li>
<p>Add your Office 365 tenant name to the <code>web.config</code>:</p>

<ol>
<li>Open the <code>web.config</code> file in the project.</li>
<li>
<p>Add the following node to the <code>&lt;appSettings&gt;</code> section, setting the value equal to the ID of your Office 365 account:</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">add</span> <span class="pl-e">key</span>=<span class="pl-s1"><span class="pl-pds">"</span>ida:O365TenantId<span class="pl-pds">"</span></span> <span class="pl-e">value</span>=<span class="pl-s1"><span class="pl-pds">"</span>######<span class="pl-pds">"</span></span>/&gt;</pre></div>

<blockquote>
<p>For example, if the root of your Office 365 tenant is <code>https://contoso.sharepoint.com</code>, you would enter <strong>contoso</strong> in this setting.</p>
</blockquote>
</li>
</ol>
</li>
<li>
<p>Now you need a few NuGet packages to enable OWIN OpenID Connect authentication &amp; to create a secure token cache (using Entity Framework) in the application:</p>

<ol>
<li>Open the Package Manager Console: <strong>View/Other Windows/Package Manager Console</strong>.</li>
<li>
<p>Enter each line below in the console, one at a time, pressing <strong>ENTER</strong> after each one. NuGet will install the package and all dependent packages:</p>

<div class="highlight highlight-powershell"><pre>PM&gt; <span class="pl-k"><span class="pl-k">Install-Package</span></span> <span class="pl-k">-</span>Id EntityFramework
PM&gt; <span class="pl-k"><span class="pl-k">Install-Package</span></span> <span class="pl-k">-</span>Id Microsoft.IdentityModel.Clients.ActiveDirectory
PM&gt; <span class="pl-k"><span class="pl-k">Install-Package</span></span> <span class="pl-k">-</span>Id Microsoft.Owin.Host.SystemWeb
PM&gt; <span class="pl-k"><span class="pl-k">Install-Package</span></span> <span class="pl-k">-</span>Id Microsoft.Owin.Security.Cookies
PM&gt; <span class="pl-k"><span class="pl-k">Install-Package</span></span> <span class="pl-k">-</span>Id Microsoft.Owin.Security.OpenIdConnect</pre></div>
</li>
</ol>
</li>
<li>
<p>Add a new model that will be used by our persistent token cache:</p>

<ol>
<li>Right-click <strong>Models</strong> folder in the project and select <strong>Add/Class</strong>.</li>
<li>Name the class <strong>PerWebUserCache.cs</strong>.</li>
<li>
<p>When the file has been created, add the following code to the class:</p>

<div class="highlight highlight-c#"><pre>[Key]
<span class="pl-s">public</span> <span class="pl-st">int</span> EntryId { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">string</span> webUserUniqueId { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">byte</span>[] cacheBits { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> DateTime LastWrite { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }</pre></div>
</li>
<li>
<p>At the top of the file, add the following <code>using</code> statement:</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> System.ComponentModel.DataAnnotations;</pre></div>
</li>
</ol>
</li>
<li>
<p>Add a new persistent data store that will be used for the token cache:</p>

<ol>
<li>Right-click the project and select <strong>Add/New Folder</strong>.</li>
<li>Name the folder <strong>Data</strong>.</li>
<li>Locate the <a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Lab%20Files">Lab Files</a> folder provided with this lab &amp; find two files: <code>TasksWebContext.cs</code> &amp; <code>TasksebInitializer.cs</code>. Copy these two files to the <strong>Data</strong> folder you just created.</li>
</ol>
</li>
<li>
<p>Add a token cache that leverages Entity Framework to store the user specific tokens in persistent storage:</p>

<ol>
<li>Right-click the project and select <strong>Add/New Folder</strong>.</li>
<li>Name the folder <strong>Utils</strong>.</li>
<li>
<p>Locate the <a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Lab%20Files">Lab Files</a> folder provided with this lab &amp; find the file <code>EDADALTokenCache.cs</code>. Copy that file to the <strong>Utils</strong> folder.</p>

<blockquote>
<p>Take a moment to examine this file. It uses the <code>DbContext</code> you added in the previous step to implement a <code>TokenCache</code> which you will use in a moment. This will store the token received from a successful authentication in a persistent store.</p>
</blockquote>
</li>
</ol>
</li>
<li>
<p>Add a helper class that will be used to harvest settings out of the <code>web.config</code> and create the necessary strings that will be used for authentication:</p>

<ol>
<li>Locate the <a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Lab%20Files">Lab Files</a> folder provided with this lab &amp; find the file <code>SettingsHelper.cs</code>. Copy that file to the <strong>Utils</strong> folder.</li>
</ol>
</li>
<li>
<p>Configure the app to run startup code when the OWIN libraries startup:</p>

<ol>
<li>Right-click the project and select <strong>Add/Class</strong>.</li>
<li>Name the class <strong>Startup.cs</strong>.</li>
<li>
<p>Add the following <code>using</code> statements after the existing <code>using</code> statements:</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> Owin;
<span class="pl-k">using</span> Microsoft.Owin;</pre></div>
</li>
<li>
<p>Add the following assembly directive to call the <code>Startup.Configuration()</code> method when OWIN starts up. Note that you will only point to the class:</p>

<div class="highlight highlight-c#"><pre>[assembly:OwinStartup(<span class="pl-k">typeof</span>(TasksWeb.Startup))]</pre></div>
</li>
<li>
<p>Update the signature of the <code>Startup</code> class to be a partial class as you will create another in the next step. Do this by adding the <code>partial</code> keyword after the <code>public</code> statement so it looks like the following:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">partial</span> <span class="pl-s">class</span> <span class="pl-en">Startup</span> {}</pre></div>
</li>
<li>
<p>Add the following <code>Confguration()</code> to the <code>Startup</code> class. This calls a method you will create in a moment:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">void</span> Configuration(IAppBuilder app)
{
  ConfigureAuth(app);
}</pre></div>
</li>
<li><p>Save your changes.</p></li>
</ol>
</li>
<li>
<p>Create an authentication process when a user hits the website:</p>

<ol>
<li>Right-click the <strong>App_Start</strong> folder and select <strong>Add/Class</strong>.</li>
<li>Name the class <strong>Startup.Auth.cs</strong>.</li>
<li>
<p>When the file opens make the following two changes:</p>

<ol>
<li>Modify the namespace to just be <code>TasksWeb</code>.</li>
<li>
<p>Modify the class declaration to be a <code>partial</code> class named <code>Startup</code> so it looks like the following:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">partial</span> <span class="pl-s">class</span> <span class="pl-en">Startup</span> {}</pre></div>
</li>
</ol>
</li>
<li>
<p>Add the following <code>using</code> statements after the existing <code>using</code> statements:</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> Microsoft.IdentityModel.Clients.ActiveDirectory;
<span class="pl-k">using</span> Microsoft.Owin.Security;
<span class="pl-k">using</span> Microsoft.Owin.Security.Cookies;
<span class="pl-k">using</span> Microsoft.Owin.Security.OpenIdConnect;
<span class="pl-k">using</span> Owin;
<span class="pl-k">using</span> System.Configuration;
<span class="pl-k">using</span> System.Threading.Tasks;
<span class="pl-k">using</span> TasksWeb.Utils;</pre></div>
</li>
<li>
<p>Add the following method to the <code>Startup</code> class:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">void</span> ConfigureAuth(IAppBuilder app) {}</pre></div>
</li>
<li>
<p>Configure the authentication type and settings for the app:</p>

<div class="highlight highlight-c#"><pre>app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);
app.UseCookieAuthentication(<span class="pl-s">new</span> CookieAuthenticationOptions());</pre></div>
</li>
<li>
<p>Now configure the OWIN authentication process, force the user to go through the login process and collect the result returned from Azure AD:</p>

<div class="highlight highlight-c#"><pre>app.UseOpenIdConnectAuthentication(<span class="pl-s">new</span> OpenIdConnectAuthenticationOptions {
  ClientId = SettingsHelper.ClientId,
  Authority = SettingsHelper.AzureADAuthority,
  Notifications = <span class="pl-s">new</span> OpenIdConnectAuthenticationNotifications() {
    <span class="pl-c">// when an auth code is received...</span>
    AuthorizationCodeReceived = (context) =&gt; {
      <span class="pl-c">// get the OpenID Connect code passed from Azure AD on successful auth</span>
      <span class="pl-st">string</span> code = context.Code;

      <span class="pl-c">// create the app credentials &amp; get reference to the user</span>
      ClientCredential creds = <span class="pl-s">new</span> ClientCredential(SettingsHelper.ClientId, SettingsHelper.ClientSecret);
      <span class="pl-st">string</span> userObjectId = context.AuthenticationTicket.Identity.FindFirst(System.IdentityModel.Claims.ClaimTypes.NameIdentifier).Value;

      <span class="pl-c">// use the OpenID Connect code to obtain access token &amp; refresh token...</span>
      <span class="pl-c">//  save those in a persistent store...</span>
      EFADALTokenCache sampleCache = <span class="pl-s">new</span> EFADALTokenCache(userObjectId);
      AuthenticationContext authContext = <span class="pl-s">new</span> AuthenticationContext(SettingsHelper.AzureADAuthority, sampleCache);

      <span class="pl-c">// obtain access token for the AzureAD graph</span>
      Uri redirectUri = <span class="pl-s">new</span> Uri(HttpContext.Current.Request.Url.GetLeftPart(UriPartial.Path));
      AuthenticationResult authResult = authContext.AcquireTokenByAuthorizationCode(code, redirectUri, creds, SettingsHelper.AzureAdGraphResourceId);

      <span class="pl-c">// successful auth</span>
      <span class="pl-k">return</span> Task.FromResult(<span class="pl-c1">0</span>);
    },
    AuthenticationFailed = (context) =&gt;
    {
      context.HandleResponse();
      <span class="pl-k">return</span> Task.FromResult(<span class="pl-c1">0</span>);
    }
  },
  TokenValidationParameters = <span class="pl-s">new</span> System.IdentityModel.Tokens.TokenValidationParameters
  {
    ValidateIssuer = <span class="pl-c1">false</span>
  }
});</pre></div>
</li>
<li><p>Save your changes.</p></li>
</ol>
</li>
<li>
<p>With the authentication process wired up into the OWIN startup process, now implement a login controller to provide sign in &amp; sign out functionality:</p>

<ol>
<li>Right-click the <strong>Controllers</strong> folder and select <strong>Add/Controller</strong>.

<ol>
<li>In the <strong>Add Scaffold</strong> dialog, select <strong>MVC 5 Controller - Empty</strong>.</li>
<li>Click <strong>Add</strong>.</li>
<li>When prompted for a name, enter <strong>AccountController</strong>.</li>
<li>Click <strong>Add</strong>.</li>
</ol>
</li>
<li>
<p>Within the <strong>AccountController</strong> file, add the following <code>using</code> statements to the top of the file:</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> TasksWeb.Utils;
<span class="pl-k">using</span> Microsoft.IdentityModel.Clients.ActiveDirectory;
<span class="pl-k">using</span> Microsoft.Owin.Security;
<span class="pl-k">using</span> Microsoft.Owin.Security.Cookies;
<span class="pl-k">using</span> Microsoft.Owin.Security.OpenIdConnect;
<span class="pl-k">using</span> System.Security.Claims;</pre></div>
</li>
<li><p>Delete the default <code>Index()</code> method from the <code>AcountController</code> class.</p></li>
<li>
<p>Add a new function to provide a sign in route. This will simply initiate a login challenge using the OWIN framework that will take the user to the Azure AD login page. When this runs, if the user has not already given the app consent to access their Office 365 data, they will be prompted to grant the app consent at this time.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">void</span> SignIn() {
  <span class="pl-k">if</span> (!Request.IsAuthenticated) {
    HttpContext.GetOwinContext().Authentication.Challenge(<span class="pl-s">new</span> AuthenticationProperties { RedirectUri = <span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span> }, OpenIdConnectAuthenticationDefaults.AuthenticationType);
  }
}</pre></div>
</li>
<li>
<p>Add a new function to provide a sign out route. This will log the user out of the site &amp; clear the local cache of tokes: </p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">void</span> SignOut() {
  <span class="pl-c">// Remove all cache entries for this user and send an OpenID Connect sign-out request.</span>
  <span class="pl-st">string</span> usrObjectId = ClaimsPrincipal.Current.FindFirst(SettingsHelper.ClaimTypeObjectIdentifier).Value;
  AuthenticationContext authContext = <span class="pl-s">new</span> AuthenticationContext(SettingsHelper.AzureADAuthority, <span class="pl-s">new</span> EFADALTokenCache(usrObjectId));
  authContext.TokenCache.Clear();

  HttpContext.GetOwinContext().Authentication.SignOut(
      OpenIdConnectAuthenticationDefaults.AuthenticationType, CookieAuthenticationDefaults.AuthenticationType);
}</pre></div>
</li>
<li>
<p>Add a pair of functions to handle requesting consent for the application.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> ActionResult ConsentApp() {
  <span class="pl-st">string</span> strResource = Request.QueryString[<span class="pl-s1"><span class="pl-pds">"</span>resource<span class="pl-pds">"</span></span>];
  <span class="pl-st">string</span> strRedirectController = Request.QueryString[<span class="pl-s1"><span class="pl-pds">"</span>redirect<span class="pl-pds">"</span></span>];

  <span class="pl-st">string</span> authorizationRequest = String.Format(
      <span class="pl-s1"><span class="pl-pds">"</span>{0}oauth2/authorize?response_type=code&amp;client_id={1}&amp;resource={2}&amp;redirect_uri={3}<span class="pl-pds">"</span></span>,
          Uri.EscapeDataString(SettingsHelper.AzureADAuthority),
          Uri.EscapeDataString(SettingsHelper.ClientId),
          Uri.EscapeDataString(strResource),
          Uri.EscapeDataString(String.Format(<span class="pl-s1"><span class="pl-pds">"</span>{0}/{1}<span class="pl-pds">"</span></span>, <span class="pl-c1">this</span>.Request.Url.GetLeftPart(UriPartial.Authority), strRedirectController))
          );

  <span class="pl-k">return</span> <span class="pl-s">new</span> RedirectResult(authorizationRequest);
}

<span class="pl-s">public</span> ActionResult AdminConsentApp() {
  <span class="pl-st">string</span> strResource = Request.QueryString[<span class="pl-s1"><span class="pl-pds">"</span>resource<span class="pl-pds">"</span></span>];
  <span class="pl-st">string</span> strRedirectController = Request.QueryString[<span class="pl-s1"><span class="pl-pds">"</span>redirect<span class="pl-pds">"</span></span>];

  <span class="pl-st">string</span> authorizationRequest = String.Format(
      <span class="pl-s1"><span class="pl-pds">"</span>{0}oauth2/authorize?response_type=code&amp;client_id={1}&amp;resource={2}&amp;redirect_uri={3}&amp;prompt={4}<span class="pl-pds">"</span></span>,
          Uri.EscapeDataString(SettingsHelper.AzureADAuthority),
          Uri.EscapeDataString(SettingsHelper.ClientId),
          Uri.EscapeDataString(strResource),
          Uri.EscapeDataString(String.Format(<span class="pl-s1"><span class="pl-pds">"</span>{0}/{1}<span class="pl-pds">"</span></span>, <span class="pl-c1">this</span>.Request.Url.GetLeftPart(UriPartial.Authority), strRedirectController)),
          Uri.EscapeDataString(<span class="pl-s1"><span class="pl-pds">"</span>admin_consent<span class="pl-pds">"</span></span>)
          );

  <span class="pl-k">return</span> <span class="pl-s">new</span> RedirectResult(authorizationRequest);
}</pre></div>
</li>
<li>
<p>Add one more function to the <code>AccountController</code> class to refresh the session and reissue the OWIN authentication challenge:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">void</span> RefreshSession() {
  <span class="pl-st">string</span> strRedirectController = Request.QueryString[<span class="pl-s1"><span class="pl-pds">"</span>redirect<span class="pl-pds">"</span></span>];

  HttpContext.GetOwinContext().Authentication.Challenge(<span class="pl-s">new</span> AuthenticationProperties { RedirectUri = String.Format(<span class="pl-s1"><span class="pl-pds">"</span>/{0}<span class="pl-pds">"</span></span>, strRedirectController) }, OpenIdConnectAuthenticationDefaults.AuthenticationType);
}</pre></div>
</li>
<li>
<p>Now that the <strong>AccountController</strong> is setup, the last step is to implement the user interface components to provide sign in and sign out capabilities.</p>

<ol>
<li>Locate the <strong>Views/Shared</strong> folder in the project.</li>
<li>Right-click the folder and select <strong>Add/View</strong>.</li>
<li>
<p>Complete the <strong>Add View</strong> dialog as shown in the following picture, then click <strong>Add</strong>:</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/LoginPartial.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/LoginPartial.png" alt="" style="max-width:100%;"></a></p>
</li>
<li>
<p>Add the following code to the <strong>_LoginPartial.cshtml</strong> file:</p>

<div class="highlight highlight-asp"><pre>@<span class="pl-k">if</span> (<span class="pl-s3">Request</span>.IsAuthenticated) {
  <span class="pl-k">&lt;</span>text<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>ul <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>nav navbar-nav navbar-right<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
      <span class="pl-k">&lt;</span>li <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>navbar-text<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
        Hello, @User.Identity.Name!
      <span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
      <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>
        @Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Sign out<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SignOut<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Account<span class="pl-pds">"</span></span>)
      <span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>/ul<span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>/text<span class="pl-k">&gt;</span>
} <span class="pl-k">else</span> {
  <span class="pl-k">&lt;</span>ul <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>nav navbar-nav navbar-right<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Sign in<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SignIn<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Account<span class="pl-pds">"</span></span>, routeValues: <span class="pl-c1">null</span>, htmlAttributes: <span class="pl-st">new</span> { id <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>loginLink<span class="pl-pds">"</span></span> })<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>/ul<span class="pl-k">&gt;</span>
}</pre></div>
</li>
<li>
<p>Open the <strong>_Layout.cshtml</strong> file found in the <strong>Views/Shared</strong> folder.</p>

<ol>
<li>
<p>Locate the part of the file that includes a few links at the top of the page... it should look similar to the following code:</p>

<div class="highlight highlight-asp"><pre><span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>navbar-collapse collapse<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>ul <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>nav navbar-nav<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>About<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>About<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Contact<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Contact<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>/ul<span class="pl-k">&gt;</span>
<span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span></pre></div>
</li>
<li>
<p>Update that navigation to have a new link (the <strong>Tasks</strong> link added below) as well as a reference to the login control you just created:</p>

<div class="highlight highlight-asp"><pre><span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>navbar-collapse collapse<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>ul <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>nav navbar-nav<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>About<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>About<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Contact<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Contact<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>li<span class="pl-k">&gt;</span>@Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Tasks<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SpTask<span class="pl-pds">"</span></span>)<span class="pl-k">&lt;</span>/li<span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>/ul<span class="pl-k">&gt;</span>
  @Html.Partial(<span class="pl-s1"><span class="pl-pds">"</span>_LoginPartial<span class="pl-pds">"</span></span>)
<span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span></pre></div>

<blockquote>
<p>The <strong>Tasks</strong> link will not work yet... you will add that in the next exercise.</p>
</blockquote>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Lastly, because this web application will use the antiforgery token, you need to make sure the unique ID used by the token is a value in the user claim. This should be explicitly set so you don't assume the default one is there.</p>

<ol>
<li>Open the <code>global.asax.cs</code> file in your project.</li>
<li>
<p>Add the following two statements to the end of the existing <code>using</code> statements:</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> System.Web.Helpers;
<span class="pl-k">using</span> System.IdentityModel.Claims;</pre></div>
</li>
<li>
<p>Next, add the following line to the end of the <code>Application_Start()</code> method:</p>

<div class="highlight highlight-c#"><pre>AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;</pre></div>
</li>
</ol>
</li>
<li>
<p>At this point you can test the authentication flow for your application.</p>

<ol>
<li>In Visual Studio, press <strong>F5</strong>. The browser will automatically launch taking you to the HTTPS start page for the web application.</li>
<li>To sign in, click the <strong>Sign In</strong> link the upper-right corner.</li>
<li>Login using your <strong>Organizational Account</strong>.</li>
<li>
<p>Upon a successful login, since this will be the first time you have logged into this app, Azure AD will present you with the common consent dialog that looks similar to the following image:</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/ConsentDialog.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/ConsentDialog.png" alt="" style="max-width:100%;"></a></p>
</li>
<li><p>Click <strong>OK</strong> to approve the app's permission request on your data in Office 365.</p></li>
<li>You will then be redirected back to your web application. However notice in the upper right corner, it now shows your email address &amp; the <strong>Sign Out</strong> link.</li>
</ol>
</li>
</ol>

<p>Congratulations... at this point your app is configured with Azure AD and leverages OpenID Connect and OWIN to facilitate the authentication process!</p>

<h2 id="exercise-3-use-azure-ad-access-token-to-call-sharepoint-rest-api">
<a id="user-content-exercise-3-use-azure-ad-access-token-to-call-sharepoint-rest-api" class="anchor" href="#exercise-3-use-azure-ad-access-token-to-call-sharepoint-rest-api" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exercise 3: Use Azure AD Access Token to call SharePoint REST API</h2>

<p>In this exercise, you will create a repository object for wrapping CRUD operations associated with the Tasks list and use the repository to read the list.</p>

<ol>
<li>In the <strong>Solution Explorer</strong>, right click the <strong>Models</strong> folder and select <strong>Add/Class</strong>.</li>
<li>In the <strong>Add New Item</strong> dialog, name the new class <strong>SpTask.cs</strong>.</li>
<li>Click <strong>Add</strong>.</li>
<li>
<p><strong>Add</strong> the following properties to hold data for an individual task.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">string</span> Id { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">string</span> Title { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">string</span> Priority { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">string</span> Status { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }</pre></div>
</li>
<li><p>In the <strong>Solution Explorer</strong>, right click the <strong>Models</strong> folder and select <strong>Add/Class</strong>.</p></li>
<li>In the <strong>Add New Item</strong> dialog, name the new class <strong>SpTaskRepository.cs</strong>.</li>
<li>Click <strong>Add</strong>.</li>
<li>
<p><strong>Add</strong> the following references to the top of the <code>TaskRepository</code> class.</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> Microsoft.IdentityModel.Clients.ActiveDirectory;
<span class="pl-k">using</span> Microsoft.Office365.Discovery;
<span class="pl-k">using</span> Microsoft.Office365.SharePoint;
<span class="pl-k">using</span> Newtonsoft.Json;
<span class="pl-k">using</span> System.IO;
<span class="pl-k">using</span> System.Net.Http;
<span class="pl-k">using</span> System.Net.Http.Headers;
<span class="pl-k">using</span> System.Security.Claims;
<span class="pl-k">using</span> System.Text;
<span class="pl-k">using</span> System.Threading.Tasks;
<span class="pl-k">using</span> System.Xml.Linq;
<span class="pl-k">using</span> TasksWeb.Utils;</pre></div>
</li>
<li>
<p><strong>Add</strong> the following code to return an access token you can use with the REST API.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">private</span> <span class="pl-s">async</span> Task&lt;<span class="pl-st">string</span>&gt; GetAccessToken() {
  <span class="pl-c">// fetch from stuff user claims</span>
  <span class="pl-k">var</span> signInUserId = ClaimsPrincipal.Current.FindFirst(ClaimTypes.NameIdentifier).Value;
  <span class="pl-k">var</span> userObjectId = ClaimsPrincipal.Current.FindFirst(SettingsHelper.ClaimTypeObjectIdentifier).Value;

  <span class="pl-c">// discover contact endpoint</span>
  <span class="pl-k">var</span> clientCredential = <span class="pl-s">new</span> ClientCredential(SettingsHelper.ClientId, SettingsHelper.ClientSecret);
  <span class="pl-k">var</span> userIdentifier = <span class="pl-s">new</span> UserIdentifier(userObjectId, UserIdentifierType.UniqueId);

  <span class="pl-c">// create auth context</span>
  AuthenticationContext authContext = <span class="pl-s">new</span> AuthenticationContext(SettingsHelper.AzureADAuthority, <span class="pl-s">new</span> EFADALTokenCache(signInUserId));

  <span class="pl-c">// authenticate</span>
  <span class="pl-k">var</span> authResult = await authContext.AcquireTokenSilentAsync(SettingsHelper.SharePointServiceResourceId, clientCredential, userIdentifier);

  <span class="pl-c">// obtain access token</span>
  <span class="pl-k">return</span> authResult.AccessToken;
}</pre></div>
</li>
<li>
<p>Before adding the code to submit &amp; retrieve tasks to &amp; from SharePoint, to make processing the responses easier, add a template class file that can be used to serialize &amp; deserialize the responses.</p>

<ol>
<li>Locate the <a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Lab%20Files">Lab Files</a> folder provided with this lab &amp; find the file <strong>SpTaskJson.cs</strong>. Copy that file to the <strong>Utils</strong> folder.</li>
<li>Add this file to the <strong>Models</strong> folder.</li>
</ol>
</li>
<li>
<p><strong>Add</strong> the following code to read a page of Tasks.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;List&lt;SpTask&gt;&gt; GetTasks(<span class="pl-st">int</span> pageIndex, <span class="pl-st">int</span> pageSize) {
  StringBuilder requestUri = <span class="pl-s">new</span> StringBuilder(SettingsHelper.SharePointServiceEndpoint)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>/_api/web/lists/getbytitle('Tasks')/items<span class="pl-pds">"</span></span>)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>?$select=Id,Title,Status,Priority<span class="pl-pds">"</span></span>);

  HttpClient client = <span class="pl-s">new</span> HttpClient();
  HttpRequestMessage request = <span class="pl-s">new</span> HttpRequestMessage(HttpMethod.Get, requestUri.ToString());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>ACCEPT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);
  request.Headers.Authorization = <span class="pl-s">new</span> AuthenticationHeaderValue(<span class="pl-s1"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>, await GetAccessToken());

  HttpResponseMessage response = await client.SendAsync(request);
  <span class="pl-st">string</span> responseString = await response.Content.ReadAsStringAsync();
  <span class="pl-k">var</span> spTaskJsonResponse = JsonConvert.DeserializeObject&lt;SpTaskJsonCollection&gt;(responseString);

  List&lt;SpTask&gt; tasks = <span class="pl-s">new</span> List&lt;SpTask&gt;();

  <span class="pl-k">foreach</span> (<span class="pl-k">var</span> spListitem <span class="pl-k">in</span> spTaskJsonResponse.Data.Results) {
    SpTask task = <span class="pl-s">new</span> SpTask {
      Id = spListitem.Id.ToString(),
      Title = spListitem.Title,
      Status = spListitem.Status,
      Priority = spListitem.Priority
    };
    tasks.Add(task);
  }

  <span class="pl-k">return</span> tasks.OrderBy(e =&gt; e.Title).Skip(pageIndex * pageSize).Take(pageSize).ToList();
}</pre></div>
</li>
<li>
<p>Add the following code to read a single Task item:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;SpTask&gt; GetTask(<span class="pl-st">string</span> Id) {
  StringBuilder requestUri = <span class="pl-s">new</span> StringBuilder(SettingsHelper.SharePointServiceEndpoint)
      .Append(<span class="pl-s1"><span class="pl-pds">"</span>/_api/web/lists/getbytitle('Tasks')/items<span class="pl-pds">"</span></span>)
      .Append(<span class="pl-s1"><span class="pl-pds">"</span>(<span class="pl-pds">"</span></span> + Id + <span class="pl-s1"><span class="pl-pds">"</span>)<span class="pl-pds">"</span></span>)
      .Append(<span class="pl-s1"><span class="pl-pds">"</span>?$select=Id,Title,Status,Priority<span class="pl-pds">"</span></span>);

  HttpClient client = <span class="pl-s">new</span> HttpClient();
  HttpRequestMessage request = <span class="pl-s">new</span> HttpRequestMessage(HttpMethod.Get, requestUri.ToString());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>ACCEPT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);
  request.Headers.Authorization = <span class="pl-s">new</span> AuthenticationHeaderValue(<span class="pl-s1"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>, await GetAccessToken());

  HttpResponseMessage response = await client.SendAsync(request);
  <span class="pl-st">string</span> responseString = await response.Content.ReadAsStringAsync();
  <span class="pl-k">var</span> spTaskJsonResponse = JsonConvert.DeserializeObject&lt;SpTaskJsonSingle&gt;(responseString);

  SpTask task = <span class="pl-s">new</span> SpTask {
    Id = spTaskJsonResponse.Data.Id.ToString(),
    Title = spTaskJsonResponse.Data.Title,
    Status = spTaskJsonResponse.Data.Status,
    Priority = spTaskJsonResponse.Data.Priority
  };

  <span class="pl-k">return</span> task;
}</pre></div>
</li>
<li>
<p>Add the following code to create a task:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">async</span> Task CreateTask(SpTask task) {
  StringBuilder requestUri = <span class="pl-s">new</span> StringBuilder(SettingsHelper.SharePointServiceEndpoint)
      .Append(<span class="pl-s1"><span class="pl-pds">"</span>/_api/web/lists/getByTitle('Tasks')/items<span class="pl-pds">"</span></span>);

  <span class="pl-k">var</span> newTaskJson = <span class="pl-s">new</span> SpTaskJson {
    __metadata = <span class="pl-s">new</span> __Metadata { Type = <span class="pl-s1"><span class="pl-pds">"</span>SP.Data.TasksListItem<span class="pl-pds">"</span></span> },
    Title = task.Title,
    Status = task.Status,
    Priority = task.Priority
  };

  StringContent requestContent = <span class="pl-s">new</span> StringContent(JsonConvert.SerializeObject(
    newTaskJson,
    Formatting.None,
    <span class="pl-s">new</span> JsonSerializerSettings {
      NullValueHandling = NullValueHandling.Ignore
    }));
  requestContent.Headers.ContentType = MediaTypeHeaderValue.Parse(<span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);

  HttpClient client = <span class="pl-s">new</span> HttpClient();
  HttpRequestMessage request = <span class="pl-s">new</span> HttpRequestMessage(HttpMethod.Post, requestUri.ToString());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>ACCEPT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);
  request.Headers.Authorization = <span class="pl-s">new</span> AuthenticationHeaderValue(<span class="pl-s1"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>, await GetAccessToken());
  request.Content = requestContent;

  await client.SendAsync(request);
}</pre></div>
</li>
<li>
<p>Add the following code to update a task:</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">async</span> Task UpdateTask(SpTask task) {
  StringBuilder requestUri = <span class="pl-s">new</span> StringBuilder(SettingsHelper.SharePointServiceEndpoint)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>/_api/web/lists/getByTitle('Tasks')/items<span class="pl-pds">"</span></span>)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>(<span class="pl-pds">"</span></span> + task.Id + <span class="pl-s1"><span class="pl-pds">"</span>)<span class="pl-pds">"</span></span>);

  <span class="pl-k">var</span> newTaskJson = <span class="pl-s">new</span> SpTaskJson {
    __metadata = <span class="pl-s">new</span> __Metadata { Type = <span class="pl-s1"><span class="pl-pds">"</span>SP.Data.TasksListItem<span class="pl-pds">"</span></span> },
    Title = task.Title,
    Status = task.Status,
    Priority = task.Priority
  };

  StringContent requestContent = <span class="pl-s">new</span> StringContent(JsonConvert.SerializeObject(
    newTaskJson,
    Formatting.None,
    <span class="pl-s">new</span> JsonSerializerSettings {
      NullValueHandling = NullValueHandling.Ignore
    }));
  requestContent.Headers.ContentType = MediaTypeHeaderValue.Parse(<span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);

  HttpClient client = <span class="pl-s">new</span> HttpClient();
  HttpRequestMessage request = <span class="pl-s">new</span> HttpRequestMessage(HttpMethod.Post, requestUri.ToString());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>ACCEPT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);
  request.Headers.Authorization = <span class="pl-s">new</span> AuthenticationHeaderValue(<span class="pl-s1"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>, await GetAccessToken());
  request.Content = requestContent;
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>IF-MATCH<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>);
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>X-HTTP-Method<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>MERGE<span class="pl-pds">"</span></span>);

  await client.SendAsync(request);
}</pre></div>
</li>
<li>
<p>Add the following code to delete a task: </p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-s">async</span> Task Delete(<span class="pl-st">string</span> Id) {
  StringBuilder requestUri = <span class="pl-s">new</span> StringBuilder(SettingsHelper.SharePointServiceEndpoint)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>/_api/web/lists/getByTitle('Tasks')/items<span class="pl-pds">"</span></span>)
    .Append(<span class="pl-s1"><span class="pl-pds">"</span>(<span class="pl-pds">"</span></span> + Id + <span class="pl-s1"><span class="pl-pds">"</span>)<span class="pl-pds">"</span></span>);

  HttpClient client = <span class="pl-s">new</span> HttpClient();
  HttpRequestMessage request = <span class="pl-s">new</span> HttpRequestMessage(HttpMethod.Delete, requestUri.ToString());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>ACCEPT<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>application/json;odata=verbose<span class="pl-pds">"</span></span>);
  request.Headers.Authorization = <span class="pl-s">new</span> AuthenticationHeaderValue(<span class="pl-s1"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>, await GetAccessToken());
  request.Headers.Add(<span class="pl-s1"><span class="pl-pds">"</span>IF-MATCH<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>);
  HttpResponseMessage response = await client.SendAsync(request);
}</pre></div>
</li>
</ol>

<h2 id="exercise-4-code-the-mvc-application">
<a id="user-content-exercise-4-code-the-mvc-application" class="anchor" href="#exercise-4-code-the-mvc-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exercise 4: Code the MVC Application</h2>

<p>In this exercise, you will code the MVC application to allow navigating the tasks collection.</p>

<ol>
<li>In the <strong>Solution Explorer</strong>, right click the <strong>Models</strong> folder and select <strong>Add/Class</strong>.

<ol>
<li>In the <strong>Add New Item</strong> dialog, name the new class <strong>SpTaskViewModel.cs</strong>.</li>
<li>Click <strong>Add</strong>.</li>
</ol>
</li>
<li>
<p>Add the following method to hold data for the view.</p>

<div class="highlight highlight-c#"><pre><span class="pl-s">public</span> <span class="pl-st">int</span> PageIndex { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> <span class="pl-st">int</span> PageSize { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
<span class="pl-s">public</span> List&lt;SpTask&gt; SpTasks { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }</pre></div>
</li>
<li>
<p>Right-click the <strong>Controllers</strong> folder and select <strong>Add/Controller</strong>.</p>

<ol>
<li>In the <strong>Add Scaffold</strong> dialog, select <strong>MVC 5 Controller - Empty</strong> and click <strong>Add</strong>.</li>
<li>In the <strong>Add Controller</strong> dialog, give the controller the name <strong>SpTaskController</strong> and click <strong>Add</strong>.</li>
</ol>
</li>
<li>
<p><strong>Add</strong> the following references to the top of the file.</p>

<div class="highlight highlight-c#"><pre><span class="pl-k">using</span> System.Threading.Tasks;
<span class="pl-k">using</span> TasksWeb.Models;</pre></div>
</li>
<li>
<p>Add the following method to the controller to get a list of tasks and add them to the model. This will also handle deleting items if they are posted to this route.</p>

<div class="highlight highlight-c#"><pre>[Authorize]
<span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;ActionResult&gt; Index(<span class="pl-st">int</span>? pageIndex, <span class="pl-st">int</span>? pageSize, <span class="pl-st">string</span> taskId) {
  SpTaskRepository repository = <span class="pl-s">new</span> SpTaskRepository();

  <span class="pl-k">if</span> (Request.HttpMethod == <span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span> &amp;&amp; taskId != <span class="pl-c1">null</span>)
  {
    await repository.Delete(taskId);
    <span class="pl-k">return</span> Redirect(<span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>);
  }

  SpTaskViewModel model = <span class="pl-s">new</span> SpTaskViewModel();

  <span class="pl-k">if</span> (pageIndex == <span class="pl-c1">null</span>) {
    model.PageIndex = <span class="pl-c1">0</span>;
  } <span class="pl-k">else</span> {
    model.PageIndex = (<span class="pl-st">int</span>)pageIndex;
  }

  <span class="pl-k">if</span> (pageSize == <span class="pl-c1">null</span>) {
    model.PageSize = <span class="pl-c1">10</span>;
  } <span class="pl-k">else</span> {
    model.PageSize = (<span class="pl-st">int</span>)pageSize;
  }

  model.SpTasks = await repository.GetTasks(model.PageIndex, model.PageSize);

  <span class="pl-k">return</span> View(model);
}</pre></div>
</li>
<li>
<p>Within the <code>SpTaskController</code> class, right click the <code>View()</code> at the end of the <code>Index()</code> method and select <strong>Add View</strong>.</p>

<ol>
<li>
<p>Within the <strong>Add View</strong> dialog, set the following values:</p>

<ol>
<li>View Name: <strong>Index</strong>.</li>
<li>
<p>Template: <strong>Empty (without model)</strong>.</p>

<blockquote>
<p>Leave all other fields blank &amp; unchecked.</p>
</blockquote>
</li>
<li><p>Click <strong>Add</strong>.</p></li>
</ol>
</li>
</ol>
</li>
<li>
<p><strong>Replace</strong> all of the code in the file with the following:</p>

<div class="highlight highlight-asp"><pre>@model TasksWeb.Models.SpTaskViewModel

@{
  ViewBag.Title <span class="pl-k">=</span> <span class="pl-s1"><span class="pl-pds">"</span>Tasks<span class="pl-pds">"</span></span>;
}

<span class="pl-k">&lt;</span>h2<span class="pl-k">&gt;</span>Tasks<span class="pl-k">&lt;</span>/h2<span class="pl-k">&gt;</span>

<span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span> style<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>margin-top:50px;<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
    @{
      Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span> attributes4 <span class="pl-k">=</span> <span class="pl-st">new</span> Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span>();
      attributes4.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>class<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>btn btn-default<span class="pl-pds">"</span></span>);
      @Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>New Task<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Create<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SpTask<span class="pl-pds">"</span></span>, <span class="pl-c1">null</span>, attributes4);
    }
  <span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span>
<span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span>
<span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span> style<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>margin-top:50px;<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>table-responsive<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
      <span class="pl-k">&lt;</span>table id<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>filesTable<span class="pl-pds">"</span></span> <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>table table-striped table-bordered<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
        <span class="pl-k">&lt;</span>thead<span class="pl-k">&gt;</span>
          <span class="pl-k">&lt;</span>tr<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>th<span class="pl-k">&gt;&lt;</span>/th<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>th<span class="pl-k">&gt;&lt;</span>/th<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>th<span class="pl-k">&gt;</span>Title<span class="pl-k">&lt;</span>/th<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>th<span class="pl-k">&gt;</span><span class="pl-sc">Status</span><span class="pl-k">&lt;</span>/th<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>th<span class="pl-k">&gt;</span>Priority<span class="pl-k">&lt;</span>/th<span class="pl-k">&gt;</span>
          <span class="pl-k">&lt;</span>/tr<span class="pl-k">&gt;</span>
        <span class="pl-k">&lt;</span>/thead<span class="pl-k">&gt;</span>
        <span class="pl-k">&lt;</span>tbody<span class="pl-k">&gt;</span>
          @foreach (var task <span class="pl-k">in</span> @Model.SpTasks) {
            <span class="pl-k">&lt;</span>tr<span class="pl-k">&gt;</span>
              <span class="pl-k">&lt;</span>td<span class="pl-k">&gt;</span>
                @using (Html.BeginForm()) {
                  @Html.AntiForgeryToken()
                  <span class="pl-k">&lt;</span>input type<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> id<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>taskId<span class="pl-pds">"</span></span> name<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>taskId<span class="pl-pds">"</span></span> value<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>@task.Id<span class="pl-pds">"</span></span> /<span class="pl-k">&gt;</span>
                  <span class="pl-k">&lt;</span>input type<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> value<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>Delete<span class="pl-pds">"</span></span> <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>btn btn-warning<span class="pl-pds">"</span></span> /<span class="pl-k">&gt;</span>
                }
              <span class="pl-k">&lt;</span>/td<span class="pl-k">&gt;</span>
              <span class="pl-k">&lt;</span>td<span class="pl-k">&gt;</span>
                @{
                Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span> attributes2 <span class="pl-k">=</span> <span class="pl-st">new</span> Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span>();
                attributes2.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>class<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>btn btn-default<span class="pl-pds">"</span></span>);

                RouteValueDictionary routeValues2 <span class="pl-k">=</span> <span class="pl-st">new</span> RouteValueDictionary();
                routeValues2.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>taskId<span class="pl-pds">"</span></span>, task.Id);
                @Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Details<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Details<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SpTask<span class="pl-pds">"</span></span>, routeValues2, attributes2);
                }
              <span class="pl-k">&lt;</span>/td<span class="pl-k">&gt;</span>
              <span class="pl-k">&lt;</span>td<span class="pl-k">&gt;</span>
                @task.Title
              <span class="pl-k">&lt;</span>/td<span class="pl-k">&gt;</span>
              <span class="pl-k">&lt;</span>td<span class="pl-k">&gt;</span>
                @task.<span class="pl-sc">Status</span>
              <span class="pl-k">&lt;</span>/td<span class="pl-k">&gt;</span>
              <span class="pl-k">&lt;</span>td<span class="pl-k">&gt;</span>
                @task.Priority
              <span class="pl-k">&lt;</span>/td<span class="pl-k">&gt;</span>
            <span class="pl-k">&lt;</span>/tr<span class="pl-k">&gt;</span>
          }
        <span class="pl-k">&lt;</span>/tbody<span class="pl-k">&gt;</span>
      <span class="pl-k">&lt;</span>/table<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span>
    <span class="pl-k">&lt;</span>div <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>btn btn-group-sm<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
      @{
        Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span> attributes3 <span class="pl-k">=</span> <span class="pl-st">new</span> Dictionary<span class="pl-k">&lt;</span><span class="pl-s3">string</span>, object<span class="pl-k">&gt;</span>();
        attributes3.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>class<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>btn btn-default<span class="pl-pds">"</span></span>);

        RouteValueDictionary routeValues3 <span class="pl-k">=</span> <span class="pl-st">new</span> RouteValueDictionary();
        routeValues3.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>pageIndex<span class="pl-pds">"</span></span>, (Model.PageIndex <span class="pl-k">==</span> <span class="pl-c1">0</span> ? <span class="pl-c1">0</span> : Model.PageIndex <span class="pl-k">-</span> <span class="pl-c1">1</span>).ToString());
        routeValues3.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>pageSize<span class="pl-pds">"</span></span>, Model.PageSize.ToString());
        @Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Prev<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SpTask<span class="pl-pds">"</span></span>, routeValues3, attributes3);
      }
      @{
        RouteValueDictionary routeValues4 <span class="pl-k">=</span> <span class="pl-st">new</span> RouteValueDictionary();
        routeValues4.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>pageIndex<span class="pl-pds">"</span></span>, (Model.PageIndex <span class="pl-k">+</span> <span class="pl-c1">1</span>).ToString());
        routeValues4.<span class="pl-s3">Add</span>(<span class="pl-s1"><span class="pl-pds">"</span>pageSize<span class="pl-pds">"</span></span>, Model.PageSize.ToString());
        @Html.ActionLink(<span class="pl-s1"><span class="pl-pds">"</span>Next<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>SpTask<span class="pl-pds">"</span></span>, routeValues4, attributes3);
      }
    <span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span>
  <span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span>
<span class="pl-k">&lt;</span>/div<span class="pl-k">&gt;</span></pre></div>
</li>
<li>
<p>Add the following method to the controller to get a specific task:</p>

<div class="highlight highlight-c#"><pre>[Authorize]
<span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;ActionResult&gt; Details(<span class="pl-st">string</span> taskId) {
  SpTaskRepository repository = <span class="pl-s">new</span> SpTaskRepository();

  SpTask task = await repository.GetTask(taskId);

  <span class="pl-k">return</span> View(task);
}</pre></div>
</li>
<li>
<p>Within the <code>SpTaskController</code> class, right click the <code>View()</code> at the end of the <code>Details()</code> method and select <strong>Add View</strong>.</p>

<ol>
<li>
<p>Within the <strong>Add View</strong> dialog, set the following values:</p>

<ol>
<li>View Name: <strong>Detail</strong>.</li>
<li>Template: <strong>Details</strong>.</li>
<li>Model class: <strong>SpTask (TasksWeb.Models)</strong>.</li>
<li>
<p>Click <strong>Add</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddDetailsView.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddDetailsView.png" alt="" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Add the following method to the controller to create a specific task:</p>

<div class="highlight highlight-c#"><pre>[Authorize]
<span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;ActionResult&gt; Create(SpTask task)
{
  SpTaskRepository repository = <span class="pl-s">new</span> SpTaskRepository();

  <span class="pl-k">if</span> (Request.HttpMethod == <span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>)
  {
    await repository.CreateTask(task);
    <span class="pl-k">return</span> Redirect(<span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>);
  }
  <span class="pl-k">else</span>
  {
    <span class="pl-k">return</span> View(task);
  }
}</pre></div>
</li>
<li>
<p>Within the <code>SpTaskController</code> class, right click the <code>View()</code> at the end of the <code>Create()</code> method and select <strong>Add View</strong>.</p>

<ol>
<li>
<p>Within the <strong>Add View</strong> dialog, set the following values:</p>

<ol>
<li>View Name: <strong>Create</strong>.</li>
<li>Template: <strong>Create</strong>.</li>
<li>Model class: <strong>SpTask (TasksWeb.Models)</strong>.</li>
<li>
<p>Click <strong>Add</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddCreateView.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddCreateView.png" alt="" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Add the following method to the controller to edit a specific task:</p>

<div class="highlight highlight-c#"><pre>[Authorize]
<span class="pl-s">public</span> <span class="pl-s">async</span> Task&lt;ActionResult&gt; Edit(<span class="pl-st">string</span> Id, SpTask task)
{
  SpTaskRepository repository = <span class="pl-s">new</span> SpTaskRepository();

  <span class="pl-k">if</span> (Request.HttpMethod == <span class="pl-s1"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>)
  {
    await repository.UpdateTask(task);
    <span class="pl-k">return</span> Redirect(<span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>);
  }
  <span class="pl-k">else</span>
  {
    task = await repository.GetTask(Id);
    <span class="pl-k">return</span> View(task);
  }
}</pre></div>
</li>
<li>
<p>Within the <code>SpTaskController</code> class, right click the <code>View()</code> at the end of the <code>Edit()</code> method and select <strong>Add View</strong>.</p>

<ol>
<li>
<p>Within the <strong>Add View</strong> dialog, set the following values:</p>

<ol>
<li>View Name: <strong>Edit</strong>.</li>
<li>Template: <strong>Edit</strong>.</li>
<li>Model class: <strong>SpTask (TasksWeb.Models)</strong>.</li>
<li>
<p>Click <strong>Add</strong>.</p>

<p><a href="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddEditView.png" target="_blank"><img src="/Users/andrewconnell/Repositories/TrainingContent/O3653-4%20Deep%20Dive%20into%20Office%20365%20APIs%20for%20SharePoint%20Site%20services/Images/AddEditView.png" alt="" style="max-width:100%;"></a></p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>Press <strong>F5</strong> to begin debugging.</p></li>
<li>Test the list, detail, paging, creation, edit and delete functionality of the application.</li>
</ol>

<p>Congratulations! You have completed working with the SharePoint Site APIs.</p>
</article></body></html>